<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Visualize the colors of an image as a 3D RGB point cloud</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				color: #cccccc;
				font-family:Monospace;
				font-size:13px;
				
				background-color: #333;
				margin: 0px;
				overflow: hidden;
				
				line-height: 20px;
			}
			
			#container
			{
			    z-index: 10;
			}

			#info {
				position: absolute;
				top: 0px; width: 100%;
				padding: 5px;
			}
			#image_holder
			{
			    float: left;
			    text-align: center;
			}
			#image
			{
			    max-width: 200px;
			    height: auto;
			}
			#img_name
			{
			    max-width: 200px;
			}

			a {

				color: #0080ff;
			}
		</style>
	</head>
	<body>

		<div id="container"></div>
		<div id="info">
		    <div>Visualize the colors of an image as a 3D RGB point cloud.</div>
		    
		    <div id="image_holder">
		        <a id="img_info" href="#" target="_blank">
                    <div id="img_name">image name</div>
                    <img id="image" src="" alt="Visualized image">
                </a>
                <div id="debug"></div>
                <br>
                <input id="upload" type="file">
    		</div>
    	</div>

		<script src="js/three.min.js"></script>

        <script src="js/controls/TrackballControls.js"></script>
		<script src="js/Detector.js"></script>
		<script src="js/libs/stats.min.js"></script>
		<script src="js/purl.js"></script>

		<script>
			if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

			var container, stats;

			var camera, scene, renderer, controls;

			var particleSystem;
			var img;

            init3D();
            if( purl().param('image') !== undefined )
            {
                loadImage( decodeURI( purl().param('image') ) );
            }
            else
            {
                loadImage( 'pigs.jpg' );
            }
            
            function loadImage( url, name )
            {
                // The 'name' parameter is optional and defaults to 'url'.
                if( name === undefined ) name = url;
                
                document.getElementById('img_info').href = url;
                document.getElementById('img_name').innerHTML = name;
                /*
                if( url.length > 255 ) {
                    // TODO: Just use overflow: scroll and put the whole thing there.
                    document.getElementById('img_name').innerHTML = '...' + url.substr( -255, 255 );
                } else {
                    document.getElementById('img_name').innerHTML = url;
                }
                */
                
                img = document.getElementById('image');
                // Set the crossOrigin property.
                // From: http://stackoverflow.com/questions/19869150/html5-canvas-element-getimagedata-cross-origin-error
                // From: https://developer.mozilla.org/en-US/docs/Web/HTML/CORS_settings_attributes
                // UPDATE: We do this in the HTML itself, so we don't need this here.
                // UPDATE 2: Setting the cross-origin policy causes this to break on Safari.
                // img.crossOrigin = '';
                // img.crossOrigin = 'anonymous';
                // img.crossOrigin = 'use-credentials';
                
                // Wait until loaded.
                // From: http://stackoverflow.com/questions/280049/javascript-callback-for-knowing-when-an-image-is-loaded/24201249#24201249
                // UPDATE: img.complete returns true for Firefox before the image is actually complete.
                img.onload = createParticles;
                img.onerror = function() { alert( 'Error loading image.' ); console.error( 'Error loading image:' ); console.error( url ) };
                
                img.src = url;
            }
            function uploadImageFile()
            {
                // From: http://stackoverflow.com/questions/22087076/how-to-make-a-simple-image-upload-using-javascript-html
                img = document.getElementById('image');
                file = document.getElementById('upload').files[0];
                
                var reader  = new FileReader();
                reader.onload = function() {
                   loadImage( reader.result, file.name );
                }
                
                if( file ) {
                   reader.readAsDataURL( file ); //reads the data as a URL
                } else {
                   alert( 'Failed to load file.' );
                }
            }
            document.getElementById('upload').onchange = uploadImageFile;
            
			function createParticles()
            {
                if( particleSystem !== undefined ) scene.remove( particleSystem );
                
				// Get the particles from the image's pixels.
				// From: http://stackoverflow.com/questions/1041399/how-to-use-javascript-or-jquery-to-read-a-pixel-of-an-image
				var canvas = document.createElement('canvas');
				canvas.width = img.naturalWidth;
				canvas.height = img.naturalHeight;
				var ctx = canvas.getContext("2d");
				ctx.drawImage( img, 0, 0, img.naturalWidth, img.naturalHeight );
				// getImageData returns an RGBA byte array.
				var pixels = ctx.getImageData( 0, 0, canvas.width, canvas.height ).data;
                
				var particles = canvas.width*canvas.height;

				var geometry = new THREE.BufferGeometry();

				var positions = new Float32Array( particles * 3 );
				var colors = new Float32Array( particles * 3 );

				var color = new THREE.Color();

				for ( var i = 0; i < particles; i += 1 ) {

					// colors

					var r = pixels[ 4*i + 0 ]/255.;
					var g = pixels[ 4*i + 1 ]/255.;
					var b = pixels[ 4*i + 2 ]/255.;
					
					positions[ 3*i + 0 ] = r;
					positions[ 3*i + 1 ] = g;
					positions[ 3*i + 2 ] = b;

					color.setRGB( r, g, b );

					colors[ 3*i + 0 ] = color.r;
					colors[ 3*i + 1 ] = color.g;
					colors[ 3*i + 2 ] = color.b;

				}
				
				document.getElementById('debug').innerHTML = 'width: ' + img.naturalWidth + ', height: ' + img.naturalHeight + '<br>total pixels: ' + particles; 

				geometry.addAttribute( 'position', new THREE.BufferAttribute( positions, 3 ) );
				geometry.addAttribute( 'color', new THREE.BufferAttribute( colors, 3 ) );

				geometry.computeBoundingSphere();

				//

				var material = new THREE.PointCloudMaterial( { size: 5/255., vertexColors: THREE.VertexColors } );

				particleSystem = new THREE.PointCloud( geometry, material );
				// return particleSystem;
				scene.add( particleSystem );
				
				render();
			}
			
            function buildAxis( src, dst, colorHex, dashed ) {
                // From: http://soledadpenades.com/articles/three-js-tutorials/drawing-the-coordinate-axes/
                var geom = new THREE.Geometry();
                var mat;
                
                if( dashed ) {
                    mat = new THREE.LineDashedMaterial({ linewidth: 1, color: colorHex, dashSize: 10/255., gapSize: 5/255. });
                } else {
                    mat = new THREE.LineBasicMaterial({ linewidth: 2, color: colorHex });
                }
                
                geom.vertices.push( src.clone() );
                geom.vertices.push( dst.clone() );
                geom.computeLineDistances(); // This one is SUPER important, otherwise dashed lines will appear as simple plain lines
                
                var axis = new THREE.Line( geom, mat, THREE.LinePieces );
                
                return axis;
            }
			function buildAxes( length )
			{
			    // From: http://soledadpenades.com/articles/three-js-tutorials/drawing-the-coordinate-axes/
                var axes = new THREE.Object3D();
                axes.add( buildAxis( new THREE.Vector3( 0, 0, 0 ), new THREE.Vector3( length, 0, 0 ), 0xFF0000, false ) ); // +X
                // axes.add( buildAxis( new THREE.Vector3( 0, 0, 0 ), new THREE.Vector3( -length, 0, 0 ), 0xFF0000, true) ); // -X
                axes.add( buildAxis( new THREE.Vector3( 0, 0, 0 ), new THREE.Vector3( 0, length, 0 ), 0x00FF00, false ) ); // +Y
                // axes.add( buildAxis( new THREE.Vector3( 0, 0, 0 ), new THREE.Vector3( 0, -length, 0 ), 0x00FF00, true ) ); // -Y
                axes.add( buildAxis( new THREE.Vector3( 0, 0, 0 ), new THREE.Vector3( 0, 0, length ), 0x0000FF, false ) ); // +Z
                // axes.add( buildAxis( new THREE.Vector3( 0, 0, 0 ), new THREE.Vector3( 0, 0, -length ), 0x0000FF, true ) ); // -Z
                
                // XY
                axes.add( buildAxis( new THREE.Vector3( length, 0, 0 ), new THREE.Vector3( length, length, 0 ), 0xFFFF00, true) );
                axes.add( buildAxis( new THREE.Vector3( 0, length, 0 ), new THREE.Vector3( length, length, 0 ), 0xFFFF00, true) );
                
                // YZ
                axes.add( buildAxis( new THREE.Vector3( 0, length, 0 ), new THREE.Vector3( 0, length, length ), 0x00FFFF, true) );
                axes.add( buildAxis( new THREE.Vector3( 0, 0, length ), new THREE.Vector3( 0, length, length ), 0x00FFFF, true) );
                
                // XZ
                axes.add( buildAxis( new THREE.Vector3( length, 0, 0 ), new THREE.Vector3( length, 0, length ), 0xFF00FF, true) );
                axes.add( buildAxis( new THREE.Vector3( 0, 0, length ), new THREE.Vector3( length, 0, length ), 0xFF00FF, true) );
                
                // XY from 1,1,1
                axes.add( buildAxis( new THREE.Vector3( length, length, length ), new THREE.Vector3( length, length, 0 ), 0xFFFFFF, true) );
                
                // YZ from 1,1,1
                axes.add( buildAxis( new THREE.Vector3( length, length, length ), new THREE.Vector3( 0, length, length ), 0xFFFFFF, true) );
                
                // XZ from 1,1,1
                axes.add( buildAxis( new THREE.Vector3( length, length, length ), new THREE.Vector3( length, 0, length ), 0xFFFFFF, true) );
                
                return axes;
			}
			
			function initControls( camera ) {
			    controls = new THREE.TrackballControls( camera );
			    controls.target.set( .5, .5, .5 );
			    
			    controls.rotateSpeed = 1.0;
				controls.zoomSpeed = 1.2;
				controls.panSpeed = 0.8;

				controls.noZoom = false;
				controls.noPan = false;

				controls.staticMoving = true;
				controls.dynamicDampingFactor = 0.3;

				// controls.keys = [ 65, 83, 68 ];

				controls.addEventListener( 'change', render );
			}
			
			function init3D() {

				container = document.getElementById( 'container' );

				//

				camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 10 );
				camera.position.set( .5, .5, 3 );
				camera.lookAt( new THREE.Vector3( .5, .5, .5 ) );
				// camera = new THREE.OrthographicCamera( -1, 2, 2, -1, 1, 4 );
				// camera.position.z = 4;

				scene = new THREE.Scene();
				// scene.fog = new THREE.Fog( 0x050505, 2000, 3500 );
                
                //
                
                // scene.add( createParticles() );
				scene.add( buildAxes( 1. ) );
                
				//

				renderer = new THREE.WebGLRenderer( { antialias: false } );
				// renderer.setClearColor( scene.fog.color );
				renderer.setClearColor( new THREE.Color( '#333' ) );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );

				container.appendChild( renderer.domElement );

				//

				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				stats.domElement.style.right = '0px';
				container.appendChild( stats.domElement );

				//

				window.addEventListener( 'resize', onWindowResize, false );
                
                initControls( camera );
                
                // Start drawing
                animate();
                render();
			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );
                
                controls.handleResize();
                
                render();
			}

			//

			function animate() {
				requestAnimationFrame( animate );
                controls.update();
			}

			function render() {
				renderer.render( scene, camera );
                stats.update();
			}
		</script>

	</body>
</html>
